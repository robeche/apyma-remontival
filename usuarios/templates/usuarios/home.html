{% extends 'usuarios/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Apyma Remontival - CP Remontival IP" %}{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}

<!-- Hero Section with Carousel -->
<div class="hero-section fade-in-up">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Carousel -->
            <div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="2000">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="4" aria-label="Slide 5"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="5" aria-label="Slide 6"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="6" aria-label="Slide 7"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="7" aria-label="Slide 8"></button>
                    <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="8" aria-label="Slide 9"></button>
                </div>
                <div class="carousel-inner">
                    <!-- Slide 1: Imagen -->
                    

                    <div class="carousel-item active">
                        <img src="{% static 'usuarios/images_carrousel/SomosApyma1_noback.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>

                    <div class="carousel-item">
                        <img src="{% static 'usuarios/images_carrousel/SomosApyma2_noback.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>

                    <div class="carousel-item">
                        <img src="{% static 'usuarios/images_carrousel/SomosApyma3_noback.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>

                    <div class="carousel-item">
                        <img src="{% static 'usuarios/images_carrousel/SomosApyma4_noback.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>

                    <div class="carousel-item">
                        <img src="{% static 'usuarios/images_carrousel/SomosApyma5_noback.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>

                    <div class="carousel-item">
                        <img src="{% static 'usuarios/images_carrousel/SomosApyma6_noback.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>

                    <div class="carousel-item">
                        <img src="{% static 'usuarios/images_carrousel/SomosApyma7_noback.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>

                    <div class="carousel-item">
                        <img src="{% static 'usuarios/images_carrousel/SomosApyma8_noback.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>

                    <div class="carousel-item">
                        <img src="{% static 'usuarios/images_carrousel/APYMA.png' %}" class="d-block w-100 rounded shadow carousel-responsive-img" alt="{% trans 'Apyma Remontival' %}" style="object-fit: contain; background-color: #f8f9fa;">
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">{% trans "Anterior" %}</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">{% trans "Siguiente" %}</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Servicios -->
<div class="row g-4">
    <!-- Columna de Noticias -->
    <div class="col-lg-6">
        <div class="card card-modern fade-in-up h-100">
            <div class="card-header card-header-modern">
                <h2><i class="bi bi-newspaper"></i> {% trans "Últimas Noticias" %}</h2>
            </div>
            <div class="card-body card-body-modern">
                {% if noticias_recientes %}
                    {% for noticia in noticias_recientes %}
                        <div class="news-item mb-3 {% if not forloop.last %}border-bottom pb-3{% endif %}">
                            <div class="d-flex">
                                {% if noticia.imagen %}
                                    <div class="flex-shrink-0 me-3">
                                        <img src="{{ noticia.imagen.url }}" 
                                             alt="{{ noticia.titulo }}" 
                                             class="rounded news-thumbnail"
                                             style="width: 80px; height: 60px; object-fit: cover;">
                                    </div>
                                {% endif %}
                                <div class="flex-grow-1">
                                    <h5 class="news-title mb-1">
                                        {% get_current_language as LANGUAGE_CODE %}
                                        {% if LANGUAGE_CODE == 'eu' and noticia.titulo_eu %}
                                            {{ noticia.titulo_eu }}
                                        {% else %}
                                            {{ noticia.titulo }}
                                        {% endif %}
                                    </h5>
                                    <p class="text-muted small mb-1">
                                        <i class="bi bi-calendar3"></i> {{ noticia.fecha_publicacion|date:"d/m/Y" }}
                                    </p>
                                    <p class="news-summary mb-2">
                                        {% if LANGUAGE_CODE == 'eu' and noticia.resumen_eu %}
                                            {{ noticia.resumen_eu|truncatewords:15 }}
                                        {% else %}
                                            {{ noticia.resumen|truncatewords:15 }}
                                        {% endif %}
                                    </p>
                                    <button onclick="mostrarNoticiaModal({{ noticia.id }})" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-book-open"></i> {% trans "Leer más" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="text-center mt-3">
                        <a href="{% url 'noticias_lista' %}" class="btn btn-primary-modern btn-modern">
                            <i class="bi bi-arrow-right"></i> {% trans "Ver todas las noticias" %}
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-newspaper" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">{% trans "No hay noticias disponibles" %}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Columna de Actividades -->
    <div class="col-lg-6">
        <div class="card card-modern fade-in-up h-100">
            <div class="card-header card-header-modern">
                <h2><i class="bi bi-calendar-event"></i> {% trans "Próximas Actividades" %}</h2>
            </div>
            <div class="card-body card-body-modern">
                {% if actividades_proximas %}
                    {% for actividad in actividades_proximas %}
                        <div class="activity-item mb-3 {% if not forloop.last %}border-bottom pb-3{% endif %}">
                            <div class="d-flex">
                                {% if actividad.imagen %}
                                    <div class="flex-shrink-0 me-3">
                                        <img src="{{ actividad.imagen.url }}" 
                                             alt="{{ actividad.titulo }}" 
                                             class="rounded activity-thumbnail"
                                             style="width: 80px; height: 60px; object-fit: cover;">
                                    </div>
                                {% endif %}
                                <div class="flex-grow-1">
                                    <h5 class="activity-title mb-1">
                                        <a href="{% url 'detalle_actividad' actividad.id %}" class="text-decoration-none">
                                            {{ actividad.titulo|default:actividad.get_tipo_actividad_display }}
                                        </a>
                                    </h5>
                                    <p class="text-muted small mb-1">
                                        <i class="bi bi-calendar3"></i> {{ actividad.fecha|date:"d/m/Y" }}
                                        <i class="bi bi-clock ms-2"></i> {{ actividad.hora_comienzo|time:"H:i" }}
                                        {% if actividad.donde %}
                                            <i class="bi bi-geo-alt ms-2"></i> {{ actividad.donde }}
                                        {% endif %}
                                    </p>
                                    <p class="activity-description mb-0">
                                        {{ actividad.descripcion|truncatewords:15 }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="text-center mt-3">
                        <a href="{% url 'actividades' %}" class="btn btn-success-modern btn-modern">
                            <i class="bi bi-arrow-right"></i> {% trans "Ver todas las actividades" %}
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-calendar-event" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">{% trans "No hay actividades programadas" %}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- CSS responsivo para el carrusel -->
<style>
/* Carrusel responsivo - altura ajustada para móviles */
.carousel-responsive-img {
    height: 625px; /* Altura por defecto para escritorio */
}

@media (max-width: 768px) {
    .carousel-responsive-img {
        height: 250px !important;
    }
}

@media (min-width: 769px) and (max-width: 992px) {
    .carousel-responsive-img {
        height: 400px !important;
    }
}

/* Estilos para noticias y actividades */
.news-item, .activity-item {
    transition: all 0.3s ease;
}

.news-item:hover, .activity-item:hover {
    background-color: rgba(0, 123, 255, 0.02);
    border-radius: 8px;
    padding: 8px;
    margin: -8px;
}

.news-title a, .activity-title a {
    color: #333;
    font-size: 0.95rem;
    font-weight: 600;
    line-height: 1.3;
}

.news-title a:hover, .activity-title a:hover {
    color: #007bff;
}

.news-summary, .activity-description {
    font-size: 0.875rem;
    color: #666;
    line-height: 1.4;
}

.news-thumbnail, .activity-thumbnail {
    border: 1px solid #e9ecef;
}

/* Responsive para móviles */
@media (max-width: 768px) {
    .news-thumbnail, .activity-thumbnail {
        width: 60px !important;
        height: 45px !important;
    }
    
    .news-title, .activity-title {
        font-size: 0.9rem;
    }
    
    .news-summary, .activity-description {
        font-size: 0.8rem;
    }
}
</style>

<!-- Modal dinámico para noticias -->
<div class="modal fade" id="modalNoticiaHome" tabindex="-1" aria-labelledby="modalNoticiaHomeLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNoticiaHomeLabel">
                    <!-- Título se carga dinámicamente -->
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalNoticiaHomeBody">
                <!-- Contenido se carga dinámicamente -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "Cargando..." %}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div class="d-flex gap-2" id="modalNoticiaHomeShare">
                        <!-- Botones de compartir se cargan dinámicamente -->
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Cerrar" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para mostrar noticia en modal
function mostrarNoticiaModal(noticiaId) {
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalNoticiaHome'));
    modal.show();
    
    // Cargar contenido de la noticia via AJAX
    fetch(`/noticia/${noticiaId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar título
            document.getElementById('modalNoticiaHomeLabel').innerHTML = 
                (data.noticia.destacada ? '<span class="badge bg-warning text-dark me-2"><i class="bi bi-star-fill"></i> {% trans "Destacada" %}</span>' : '') + 
                data.noticia.titulo;
            
            // Crear contenido del modal
            let contenido = '';
            
            // Imagen si existe
            if (data.noticia.imagen) {
                contenido += `
                    <div class="text-center mb-3">
                        <img src="${data.noticia.imagen}" class="img-fluid rounded" alt="${data.noticia.titulo}" style="max-height: 300px; object-fit: contain;">
                    </div>
                `;
            }
            
            // Metadatos
            contenido += `
                <div class="mb-3">
                    <div class="d-flex flex-wrap align-items-center text-muted mb-3">
                        <span class="me-3">
                            <i class="bi bi-calendar3 me-1"></i>
                            ${data.noticia.fecha_publicacion}
                        </span>
                        <span class="me-3">
                            <i class="bi bi-person me-1"></i>
                            APYMA Remontival
                        </span>
                    </div>
                </div>
            `;
            
            // Resumen si existe
            if (data.noticia.resumen) {
                contenido += `
                    <div class="alert alert-info">
                        <strong>${data.noticia.resumen}</strong>
                    </div>
                `;
            }
            
            // Contenido principal
            contenido += `
                <div class="content">
                    ${data.noticia.contenido.replace(/\n/g, '<br>')}
                </div>
            `;
            
            // Actualizar contenido del modal
            document.getElementById('modalNoticiaHomeBody').innerHTML = contenido;
            
            // Crear botones de compartir
            const shareButtons = `
                <button class="btn btn-outline-secondary btn-sm" onclick="compartirFacebook('${data.noticia.titulo.replace(/'/g, "\\'")}')">
                    <i class="bi bi-facebook"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="compartirTwitter('${data.noticia.titulo.replace(/'/g, "\\'")}')">
                    <i class="bi bi-twitter"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="compartirWhatsApp('${data.noticia.titulo.replace(/'/g, "\\'")}')">
                    <i class="bi bi-whatsapp"></i>
                </button>
            `;
            
            document.getElementById('modalNoticiaHomeShare').innerHTML = shareButtons;
        } else {
            document.getElementById('modalNoticiaHomeBody').innerHTML = 
                '<div class="alert alert-danger">{% trans "Error al cargar la noticia" %}</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('modalNoticiaHomeBody').innerHTML = 
            '<div class="alert alert-danger">{% trans "Error al cargar la noticia" %}</div>';
    });
}

// Funciones auxiliares
function getCSRFToken() {
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        return metaToken.getAttribute('content');
    }
    
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

function compartirFacebook(titulo) {
    const url = window.location.href;
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(titulo)}`, '_blank', 'width=600,height=400');
}

function compartirTwitter(titulo) {
    const url = window.location.href;
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(titulo)}&url=${encodeURIComponent(url)}`, '_blank', 'width=600,height=400');
}

function compartirWhatsApp(titulo) {
    const url = window.location.href;
    const texto = `${titulo} - ${url}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, '_blank');
}
</script>

{% endblock %}
